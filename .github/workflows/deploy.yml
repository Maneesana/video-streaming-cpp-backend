name: CI/CD Pipeline

on:
  push:
    branches: [main] # or your default branch name
  pull_request:
    branches: [main]

env:
  AWS_REGION: us-east-1 # Change this to your AWS region
  EC2_INSTANCE_ID: ${{ secrets.EC2_INSTANCE_ID }}
  SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
  APP_DIR: /opt/video-streaming

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Install Docker Compose
        run: |
          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          sudo chmod +x /usr/local/bin/docker-compose
          docker-compose --version

      - name: Build and test
        run: |
          docker-compose build
          docker-compose up -d
          # Add your test commands here if needed
          sleep 10  # Give the application time to start
          curl -f http://localhost:8000/api/health || exit 1  # Basic health check

      - name: Stop containers
        run: docker-compose down

  deploy:
    needs: build-and-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' # Only deploy on main branch

    steps:
      - uses: actions/checkout@v3

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Install SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ env.SSH_PRIVATE_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        run: |
          # Create deployment script
          cat > deploy.sh << 'EOL'
          #!/bin/bash
          set -e

          echo "ðŸš€ Starting deployment process..."

          # Update system packages
          echo "ðŸ“¦ Updating system packages..."
          sudo apt-get update
          sudo apt-get upgrade -y

          # Install required dependencies
          echo "ðŸ“¦ Installing dependencies..."
          sudo apt-get install -y \
              build-essential \
              cmake \
              git \
              libpq-dev \
              docker.io \
              docker-compose \
              dos2unix

          # Start and enable Docker service
          echo "ðŸ³ Setting up Docker..."
          sudo systemctl start docker
          sudo systemctl enable docker

          # Add current user to docker group
          echo "ðŸ‘¤ Adding user to docker group..."
          sudo usermod -aG docker $USER

          # Create application directory
          echo "ðŸ“ Setting up application directory..."
          APP_DIR="/opt/video-streaming"
          sudo mkdir -p $APP_DIR
          sudo chown -R $USER:$USER $APP_DIR

          # Copy application files
          echo "ðŸ“‹ Copying application files..."
          cp -r ./* $APP_DIR/
          cd $APP_DIR

          # Fix line endings
          echo "ðŸ”§ Fixing line endings..."
          dos2unix configure.sh build.sh run.sh
          chmod +x configure.sh build.sh run.sh

          # Build and run with Docker
          echo "ðŸ—ï¸ Building and running application..."
          docker-compose up --build -d

          # Create systemd service file
          echo "âš™ï¸ Creating systemd service..."
          sudo tee /etc/systemd/system/video-streaming.service << EOF
          [Unit]
          Description=Video Streaming Service
          After=docker.service
          Requires=docker.service

          [Service]
          Type=simple
          User=$USER
          WorkingDirectory=$APP_DIR
          ExecStart=/usr/local/bin/docker-compose up
          ExecStop=/usr/local/bin/docker-compose down
          Restart=always

          [Install]
          WantedBy=multi-user.target
          EOF

          # Reload systemd and enable service
          echo "ðŸ”„ Setting up systemd service..."
          sudo systemctl daemon-reload
          sudo systemctl enable video-streaming
          sudo systemctl start video-streaming

          echo "âœ… Deployment completed successfully!"
          EOL

          chmod +x deploy.sh

          # Copy files to EC2
          scp -i ~/.ssh/deploy_key -r ./* ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/
          scp -i ~/.ssh/deploy_key deploy.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:/home/${{ secrets.EC2_USER }}/

          # Execute deployment script
          ssh -i ~/.ssh/deploy_key ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} './deploy.sh'
